# E09

## algo fixture genre

```php
// TODO : random genres
// entre 1 et 4 genre
for ($k=0; $k<rand(1, 5); $k++) {
    // sÃ©lection alÃ©atoire
    $genreToAdd = $genres[rand(0, count($genres)-1)];
    // rÃ©cupÃ¨re la liste des genres existant dans Movie
    $genresAlreadyAdded[] = $movie->getGenres();
    // check que le genre alÃ©atoire n'est pas dans la liste dÃ©jÃ  existante
    if (!in_array($genreToAdd, $genresAlreadyAdded)) {
        // si il n'est pas dans la liste on l'ajoute
        $movie->addGenre($genreToAdd);
    }
}
```

```php
$genreInMovie = [];
// entre 1 et 4 genre
for ($k=0; $k <= rand(1, 4) ; $k++) {
    // sÃ©lection alÃ©atoire
    $genreToAdd = $genreList[rand(0, count($genreList)-1)];

    // rÃ©cupÃ¨re la liste des genres existant dans Movie
    foreach ($movie->getGenres() as $genre) {
        $genreInMovie[] = $genre->getName();
    }
    // check que le genre alÃ©atoire n'est pas dans la liste dÃ©jÃ  existante
    if (!in_array($genreToAdd, $genreInMovie)) {
        // si il n'est pas dans la liste on l'ajoute
        $movie->addGenre($genreToAdd);
    }
}
```

[stackoverflow](https://stackoverflow.com/questions/42228296/how-can-i-generate-multiple-random-numbers-in-php-without-having-the-same)

```php
// liste de chiffres
$range = range(0, 100); 
// on mÃ©lange
shuffle($range);
// nombre de chiffre que l'on veux
$n = 10;
// on prend les N premiers
$result = array_slice($range, 0 , $n);
```

```php
// la liste des index de mon tableau de genre
$range = range(0, 49);
// on mÃ©lange
shuffle($range);
// nombre de genre alÃ©atoire
$nombreDeGenre = rand(1,4);
// on prend les N premiers index
$result = array_slice($range, 0 , $n);
```

## formulaire

### partie HTML, cotÃ© twig/client

* champs texte, champs mot de passe
* textarea (long texte, avec retour Ã  la ligne)
* liste dÃ©roulante / radio button : choix unique
* checkbox : choix multiples
* number (+/-, slider, potentiometre, jauges)

### partie controller

* rÃ©cupÃ¨re les donnÃ©es avec le `name` âš ï¸ risque d'erreur
* filter_input : netoyage de donnÃ©es, pour Ã©viter les pb de sÃ©curitÃ© (injection SQL, etc ...)
* vÃ©rifier que l'on a toutes les donnÃ©es obligatoire par rapport Ã  l'entitÃ© que l'on veux manipuler
* rÃ¨gles de format
  * longueur de la chaine de caractÃ¨re
  * regex : e-mail, numÃ©ro de tÃ©lÃ©phone, mot de passe
  * number min / max
* sÃ©curitÃ© CSRF (token)

### mise en commun des deux parties

on pourrait utiliser une entitÃ© pour gÃ©nÃ©rer notre formulaire
Dans notre entitÃ© on sait quel type de donnÃ©e est associÃ© Ã  chaque propriÃ©tÃ©
Si on connait le type de donnÃ©e, on connait donc le type de formulaire qu'il faut

movie-title = champs texte
movie-duration = number

si on gÃ©nÃ¨re le HTML, facilitons la rÃ©cupÃ©ration avec le name
ðŸ’¡ le name est le nom de la propriÃ©tÃ©

On peut dire dans notre entitÃ© si c'est `nullable` ou pas, donc obligatoire ou pas

on peut dire dans notre entitÃ© la longueur du chaine : `length=255`

filter_input + CSRF => entiÃ¨rement auto

## activer bootstrap dans twig pour les formulaires

[doc](https://symfony.com/doc/5.4/form/bootstrap5.html)

```yaml
# config/packages/twig.yaml
twig:
    default_path: '%kernel.project_dir%/templates'
    form_themes: ['bootstrap_5_layout.html.twig']
```

## comment on met tout Ã§a en place

### make:form

on gÃ©nÃ©re une classe qui va contenir les Ã©lÃ©ments du formulaire souhaitÃ©.s
grace au make:form on a fait aussi l'association avec notre classe entitÃ©

on peut modifier le comportement du formulaire dans cette classe.

[les types d'Ã©lÃ©ments de formulaires](https://symfony.com/doc/5.4/reference/forms/types.html)

[dÃ©tails TextType](https://symfony.com/doc/5.4/reference/forms/types/text.html)

```php
$builder
    ->add('username', TextType::class,
    [
        'attr' => 
            [
                'placeholder' => "votre nickname"
            ]
    ])
```

### gÃ©nÃ©rer le fomulaire depuis un controller

```php
// je crÃ©e un objet que je vais associer au formulaire
$newComment = new Comment();
// je crÃ©er un formulaire du type que l'on vient de crÃ©er avec make:form
// on lui fournit un objet pour la suite quand on reÃ§oit la soumisison du formulaire
$form = $this->createForm(CommentType::class, $newComment);
```

on doit ensuite fournir le formulaire Ã  twig

```php
$this->render("main/read.html.twig", [
    // je donne Ã  twig la version avec la vue gÃ©nÃ©rÃ©
    "formulaire" => $form->createView()
]);
```

[doc](https://symfony.com/doc/5.4/form/form_customization.html#form-rendering-functions)

```twig
{{ form(formulaire) }}
```

#### desactiver la validation html5

```twig
{{ form(formulaire, {attr: {novalidate: 'novalidate'}}) }}
```

### gestion de la soumission du formulaire

Pour gÃ©rer la soumission, il nous faut l'objet Request (injection de dÃ©pendance)

dans notre controler, aprÃ¨s avoir gÃ©nÃ©rer le formulaire, je lui demande de prendre en compte la request

```php
// le formulaire va maintenant inspecter $request pour y trouver des infos
$form->handleRequest($request);
```

Avec cette mÃ©thode le formulaire va remplir les propriÃ©tÃ©s de l'objet qu'on lui a fournit Ã  sa crÃ©ation

Pour que l'on prenne en compte la soumission du formulaire on teste si il a Ã©tÃ© validÃ©.

```php
if ($form->isSubmitted()){
    // ce que l'on a besoin de faire
    // persist + flush
}
```

### la validation des donnÃ©es

Comme tout passe par l'objet formulaire, on lui demande aussi de valider les donnÃ©es.

Pour qu'il sache les rÃ¨gles que l'on veux appliquer, on va lui dÃ©crire dans notre EntitÃ©

Pour cela symfony nous fournit des annotations spÃ©cifiques : `@Assert\`

[doc](https://symfony.com/doc/current/validation.html)

```php
use Symfony\Component\Validator\Constraints as Assert;

/**
 * @ORM\Entity(repositoryClass=CommentRepository::class)
 */
class Comment
{
    /**
     * @ORM\Column(type="text")
     * @Assert\NotBlank
     */
    private $body;

}
```

Il faut quand mÃªme que l'on demande si le formulaire est valide.

```php
 if ($form->isSubmitted() && $form->isValid()){
    // ce que l'on a besoin de faire
    // persist + flush
 }
```
